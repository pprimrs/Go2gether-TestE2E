name: ü§ñ Robot Framework E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: robot-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Robot Framework Tests
    runs-on: ubuntu-latest

    env:
      # (optional) ‡πÉ‡∏ä‡πâ Secrets -> Settings > Secrets and variables > Actions
      BASE_URL: ${{ secrets.BASE_URL }}
      API_KEY:  ${{ secrets.API_KEY }}

    steps:
      # 1) Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3) Cache pip (‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4) Install deps
      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      # 5) (optional) ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô .env ‡∏à‡∏≤‡∏Å Secrets ‡∏ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏≠‡πà‡∏≤‡∏ô .env
      - name: Create .env from secrets (optional)
        run: |
          if [ -n "${BASE_URL}" ]; then echo "BASE_URL=${BASE_URL}" >> .env; fi
          if [ -n "${API_KEY}" ];  then echo "API_KEY=${API_KEY}"   >> .env; fi
        shell: bash

      # 6) Run Robot tests (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ó‡∏™‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß job ‡∏à‡∏∞ fail ‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á)
      #    ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ workflow ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏° ‡πÉ‡∏ä‡πâ --nostatusrc (‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏≠‡∏≠‡∏Å)
      - name: Run Robot Framework Tests
        run: |
          mkdir -p reports
          robot -d reports E2E/tests
          # robot --nostatusrc -d reports E2E/tests   # <- ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ job ‡∏•‡πâ‡∏°

      # 7) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô "‡πÄ‡∏™‡∏°‡∏≠" ‡πÅ‡∏°‡πâ‡πÄ‡∏ó‡∏™‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
      - name: Upload Robot reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: robot-reports
          path: |
            reports/**
            report.html
            log.html
            output.xml
          if-no-files-found: warn

      # 8) ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Actions
      - name: Summary
        if: ${{ always() }}
        run: |
          echo "### Robot Framework Tests Finished" >> $GITHUB_STEP_SUMMARY
          echo "- Reports artifact: **robot-reports**" >> $GITHUB_STEP_SUMMARY
          echo "- Main report: \`reports/report.html\`" >> $GITHUB_STEP_SUMMARY
